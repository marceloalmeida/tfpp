name: Create Release

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

on:
  schedule:
    - cron: '1 0 * * *'
  workflow_dispatch: {}

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Get Current Branch
        id: get_branch
        run: |
          CURR_BRANCH=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
          echo "CURRENT_BRANCH=$CURR_BRANCH" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get Previous Release Version
        id: get_previous_version
        run: |
          LATEST_TAG=$(git describe --abbrev=0 --tags 2>/dev/null || echo "v0.0.0")
          echo "LATEST_TAG=$LATEST_TAG"
          echo "VERSION=${LATEST_TAG#v}" >> $GITHUB_OUTPUT

      - name: Install Release Dependencies
        run: |
          npm i -D \
            semantic-release@24.1.0 \
            conventional-changelog-conventionalcommits@8.0.0 \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator \
            @semantic-release/github \
            @semantic-release/exec

      - name: Dry Run - Check Next Version
        id: dry_run
        run: |
          NEW_VERSION=$(npx semantic-release --dry-run | grep -oP 'The next release version is \K[0-9]+\.[0-9]+\.[0-9]+' || echo "")
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

          if [ -z "$NEW_VERSION" ]; then
            echo "No version change detected based on commit messages."
            echo "RELEASE_NEEDED=false" >> $GITHUB_OUTPUT
          else
            echo "New version will be: $NEW_VERSION"
            echo "RELEASE_NEEDED=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup Go
        if: steps.dry_run.outputs.RELEASE_NEEDED == 'true'
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true
          cache-dependency-path: |
            go.mod

      - name: Import GPG key
        if: steps.dry_run.outputs.RELEASE_NEEDED == 'true'
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        id: import_gpg
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}

      - name: Install GoReleaser
        if: steps.dry_run.outputs.RELEASE_NEEDED == 'true'
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          install-only: true

      - name: Create Release
        if: steps.dry_run.outputs.RELEASE_NEEDED == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
        run: |
          npx semantic-release
          echo "::notice::ðŸŽ‰ Released version v${{ steps.dry_run.outputs.NEW_VERSION }}"

      - name: No Release Needed
        if: steps.dry_run.outputs.RELEASE_NEEDED != 'true'
        run: |
          echo "::notice:: No release needed. Commit messages don't indicate any version change."
